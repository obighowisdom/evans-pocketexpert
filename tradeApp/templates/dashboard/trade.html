<div class="container my-5">
  <div class="row g-4">
    <!-- Chart -->
    <div class="w-100">
      <div class="card shadow-sm p-3">
        <h5 class="mb-3">Live Crypto Chart</h5>
        <select id="coinSelect" class="form-select w-auto mb-3">
          <option value="bitcoin" selected>Bitcoin (BTC)</option>
          <option value="ethereum">Ethereum (ETH)</option>
          <option value="ripple">XRP</option>
          <option value="cardano">Cardano (ADA)</option>
          <option value="dogecoin">Dogecoin (DOGE)</option>
          <option value="solana">Solana (SOL)</option>
          <option value="polkadot">Polkadot (DOT)</option>
          <option value="litecoin">Litecoin (LTC)</option>
          <option value="tron">TRON (TRX)</option>
          <option value="avalanche-2">Avalanche (AVAX)</option>
        </select>
        <canvas id="priceChart" height="300"></canvas>
      </div>
    </div>

    <!-- Buy Form -->
    <!-- <div class="col-lg-4">
      <div class="card shadow-sm p-3">
        <h5 class="mb-3">Buy Crypto</h5>
        <form id="tradeForm">
          <div class="mb-3">
            <label class="form-label">Amount (USD)</label>
            <input type="number" class="form-control" id="amount" placeholder="Enter USD amount">
          </div>
          <button type="button" class="btn btn-success w-100" onclick="buyCrypto()">Buy</button>
        </form>
        <hr>
        <div id="tradeResult" class="small mt-2"></div>
      </div>
    </div> -->
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chart;
let currentCoin = "bitcoin";

// Initialize Chart
async function initChart() {
  const ctx = document.getElementById("priceChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Price (USD)",
        data: [],
        borderColor: "#007bff",
        backgroundColor: "rgba(0,123,255,0.1)",
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { ticks: { autoSkip: true, maxTicksLimit: 8 } },
        y: { beginAtZero: false }
      }
    }
  });
}

// Fetch historical + live prices
async function loadChartData(coin = "bitcoin") {
  currentCoin = coin;

  // Get last 1 day prices
  const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=usd&days=1`);
  const data = await res.json();

  const prices = data.prices.map(p => ({ time: new Date(p[0]).toLocaleTimeString(), value: p[1] }));

  chart.data.labels = prices.map(p => p.time);
  chart.data.datasets[0].data = prices.map(p => p.value);
  chart.data.datasets[0].label = coin.toUpperCase() + " / USD";
  chart.update();
}

// Fetch latest price for Buy
async function fetchPrice(coin) {
  const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coin}&vs_currencies=usd`);
  const data = await res.json();
  return data[coin].usd;
}

// Buy Button
async function buyCrypto() {
  const amount = document.getElementById("amount").value;
  if (!amount) {
    document.getElementById("tradeResult").innerHTML = `<span class="text-danger">Enter amount!</span>`;
    return;
  }

  const price = await fetchPrice(currentCoin);
  const coinsBought = (amount / price).toFixed(6);

  document.getElementById("tradeResult").innerHTML =
    `<span class="text-success">You bought ${coinsBought} ${currentCoin.toUpperCase()} @ $${price.toLocaleString()}</span>`;
}

// Auto-refresh chart every 60s
setInterval(() => loadChartData(currentCoin), 60000);

// Change coin on select
document.getElementById("coinSelect").addEventListener("change", (e) => {
  loadChartData(e.target.value);
});

// Init on load
initChart();
loadChartData("bitcoin");
</script>
